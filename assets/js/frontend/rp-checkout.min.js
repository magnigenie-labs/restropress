window.RPRESS_Checkout=function(r){"use strict";var e,s,a,t;function o(s){s.preventDefault();r(this);var a=r("#rpress-discount").val(),o=r("#rpress-discount-loader");if(""==a||a==rpress_global_vars.enter_discount)return!1;var n={action:"rpress_apply_discount",code:a,form:r("#rpress_purchase_form").serialize()};return r("#rpress-discount-error-wrap").html("").hide(),o.show(),r.ajax({type:"POST",data:n,dataType:"json",url:rpress_global_vars.ajaxurl,xhrFields:{withCredentials:!0},beforeSend:()=>{r(".rpress-discount-code-field-wrap").append('<span class="rp-loading"></span>')},complete:()=>{r(".rp-loading").remove()},success:function(s){if(s)if("valid"==s.msg){r(".rpress_cart_discount").html(s.html),r(".rpress_cart_discount_row").show(),r(".rpress_cart_amount").each(function(){r(this).text(s.total),r(this).data("total",s.total_plain)}),r("#rpress-discount",t).val(""),recalculate_taxes();var a=r("#rpress_cc_fields .rpress-input, #rpress_cc_fields .rpress-select,#rpress_cc_address .rpress-input, #rpress_cc_address .rpress-select,#rpress_payment_mode_select .rpress-input, #rpress_payment_mode_select .rpress-select");"0.00"==s.total_plain?(r("#rpress_cc_fields,#rpress_cc_address,#rpress_payment_mode_select").slideUp(),a.removeAttr("required"),r('input[name="rpress-gateway"]').val("manual")):(a.is(".card-address-2")||a.attr("required","required"),r("#rpress_cc_fields,#rpress_cc_address").slideDown()),e.trigger("rpress_discount_applied",[s])}else r("#rpress-discount-error-wrap").html('<span class="rpress_error">'+s.msg+"</span>"),r("#rpress-discount-error-wrap").show(),e.trigger("rpress_discount_invalid",[s]);else window.console&&window.console.log&&console.log(s),e.trigger("rpress_discount_failed",[s]);o.hide()}}).fail(function(r){window.console&&window.console.log&&console.log(r)}),!1}function n(s){var a={action:"rpress_remove_discount",code:r(this).data("code")};return r.ajax({type:"POST",data:a,dataType:"json",url:rpress_global_vars.ajaxurl,xhrFields:{withCredentials:!0},success:function(s){var a="0"+rpress_global_vars.decimal_separator+"00";r(".rpress_cart_amount").each(function(){rpress_global_vars.currency_sign+a!=r(this).text()&&a+rpress_global_vars.currency_sign!=r(this).text()||window.location.reload(),r(this).text(s.total),r(this).data("total",s.total_plain)}),r(".rpress_cart_discount").html(s.html),s.discounts||r(".rpress_cart_discount_row").hide(),recalculate_taxes(),r("#rpress_cc_fields,#rpress_cc_address").slideDown(),e.trigger("rpress_discount_removed",[s])}}).fail(function(r){window.console&&window.console.log&&console.log(r)}),!1}return{init:function(){e=r(document.body),s=r("#rpress_purchase_form"),a=r(".rpress_cart_amount"),a.text(),t=r("#rpress_checkout_form_wrap"),e.on("rpress_gateway_loaded",function(r){var e,a,t,o;a=(e=s).find(".card-number"),t=e.find(".card-cvc"),o=e.find(".card-expiry"),a.length&&"function"==typeof a.payment&&(a.payment("formatCardNumber"),t.payment("formatCardCVC"),o.payment("formatCardExpiry"))}),e.on("keyup change",".rpress-do-validate .card-number",function(){var e,s;e=r(this),(s=e).validateCreditCard(function(e){var a=r(".card-type");null==e.card_type?(a.removeClass().addClass("off card-type"),s.removeClass("valid"),s.addClass("error")):(a.removeClass("off"),a.addClass(e.card_type.name),e.length_valid&&e.luhn_valid?(s.addClass("valid"),s.removeClass("error")):(s.removeClass("valid"),s.addClass("error")))})}),e.on("blur change",".card-name",function(){var e=r(this);e.validateCreditCard(function(s){null!=s.card_type?(e.removeClass("valid").addClass("error"),r("#rpress-purchase-button").attr("disabled","disabled")):(e.removeClass("error").addClass("valid"),r("#rpress-purchase-button").removeAttr("disabled"))})}),e.on("submit","#rpress_payment_mode",function(){if(0==r("#rpress-gateway option:selected").val())return alert(rpress_global_vars.no_gateway),!1}),e.on("click","#rpress_payment_mode_select input",function(){r("#rpress_payment_mode_select label.rpress-gateway-option-selected").removeClass("rpress-gateway-option-selected"),r("#rpress_payment_mode_select input:checked").parent().addClass("rpress-gateway-option-selected")}),t.on("click",".rpress-apply-discount",o),t.on("keypress","#rpress-discount",function(r){if("13"==r.keyCode)return!1}),t.on("keyup","#rpress-discount",function(r){"13"==r.keyCode&&t.find(".rpress-apply-discount").trigger("click")}),e.on("click",".rpress_discount_remove",n),e.on("click",".rpress_discount_link",function(e){e.preventDefault(),r(".rpress_discount_link").parent().hide(),r("#rpress-discount-code-wrap").show().find("#rpress-discount").focus()}),e.find("#rpress-discount-code-wrap").hide(),e.find("#rpress_show_discount").show(),e.on("click",".rpress-amazon-logout #Logout",function(r){r.preventDefault(),amazon.Login.logout(),window.location=rpress_amazon.checkoutUri})},recalculate_taxes:recalculate_taxes}}(window.jQuery),window.jQuery(document).ready(RPRESS_Checkout.init);var ajax_tax_count=0;function recalculate_taxes(r){if("1"==rpress_global_vars.taxes_enabled){var e=jQuery("#rpress_cc_address");r||(r=e.find("#card_state").val());var s={action:"rpress_recalculate_taxes",billing_country:e.find("#billing_country").val(),state:r,card_zip:e.find("input[name=card_zip]").val()},a=++ajax_tax_count;jQuery.ajax({type:"POST",data:s,dataType:"json",url:rpress_global_vars.ajaxurl,xhrFields:{withCredentials:!0},success:function(r){if(a===ajax_tax_count){jQuery("#rpress_checkout_cart_wrap").html(jQuery(r.html).find('#rpress_checkout_cart_wrap').html()),jQuery(".rpress_cart_amount").html(r.total);var e=new Object;e.postdata=s,e.response=r,jQuery("body").trigger("rpress_taxes_recalculated",[e])}}}).fail(function(r){window.console&&window.console.log&&a===ajax_tax_count&&jQuery("body").trigger("rpress_taxes_recalculated",[tax_data])})}}